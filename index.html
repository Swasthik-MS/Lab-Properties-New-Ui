<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eQLM - Prototype</title>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS Reset & Variables --- */
        :root {
            --primary-color: #4a90e2; 
            --header-height: 60px;
            --sidebar-width: 260px;
            --bg-color: #f4f6f8;
            --text-color: #333;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --active-toggle: #4caf50;
            --inactive-toggle: #ccc;
            --row-hover: #f9fafb;
            --edit-mode-bg: #E3F2FD;
            --cell-pass: #d4edda;
            --cell-fail: #f8d7da;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #fff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 10;
        }

        .logo-area {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding-left: 20px;
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
        }

        .logo-img { max-height: 40px; max-width: 100%; }
        .logo-text { font-size: 24px; font-weight: 700; color: #555; }
        .logo-text span { color: #8bc34a; }

        .nav-menu { list-style: none; padding-top: 20px; overflow-y: auto; }
        .nav-item { padding: 0; }
        .nav-link {
            display: flex; align-items: center; padding: 12px 20px;
            text-decoration: none; color: #666; font-size: 14px;
            transition: all 0.2s; cursor: pointer;
        }
        .nav-link:hover { background-color: #f0f0f0; color: var(--primary-color); }
        .nav-link.active { background-color: #e8f0fe; color: var(--primary-color); border-left: 4px solid var(--primary-color); }
        .nav-icon { width: 20px; margin-right: 10px; text-align: center; }
        .nav-arrow { margin-left: auto; font-size: 10px; }

        .submenu { list-style: none; background-color: #fafafa; display: none; }
        .submenu.open { display: block; }
        .submenu-item {
            padding-left: 50px; padding-top: 10px; padding-bottom: 10px;
            font-size: 13px; color: #666; cursor: pointer; display: flex; align-items: center;
        }
        .submenu-item:hover { color: var(--primary-color); }
        .submenu-item.active-sub { color: var(--primary-color); font-weight: 500; }

        /* --- Main Content --- */
        .main-content { flex: 1; display: flex; flex-direction: column; height: 100%; }

        .top-header {
            height: var(--header-height); background-color: #fff; border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px;
        }
        .page-title { font-size: 18px; color: #444; font-weight: 500; }
        .header-actions { display: flex; align-items: center; gap: 20px; }
        .header-icon { color: #777; font-size: 16px; cursor: pointer; }
        .user-profile {
            width: 35px; height: 35px; background-color: #4caf50; color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 14px; font-weight: bold;
        }

        .content-body { flex: 1; padding: 20px; overflow-y: auto; position: relative; }
        .view-section { display: none; height: 100%; }
        .view-section.active-view { display: block; }

        /* Dashboard Tiles */
        .dashboard-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .plant-tile {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            width: 280px; height: 120px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex;
            align-items: center; justify-content: space-between;
            padding: 0 20px; color: white; cursor: pointer; transition: transform 0.2s;
        }
        .plant-tile:hover { transform: translateY(-5px); }
        .tile-name { font-size: 18px; font-weight: 500; text-transform: uppercase; }
        .tile-icon { font-size: 40px; opacity: 0.3; }

        /* Breadcrumb/Back */
        .breadcrumb-nav {
            margin-bottom: 15px; font-size: 14px; color: #666;
        }
        .breadcrumb-nav span { cursor: pointer; color: var(--primary-color); }
        .breadcrumb-nav span:hover { text-decoration: underline; }

        /* Module Header */
        .module-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .module-title { font-size: 20px; font-weight: 500; color: #333; }

        /* UI Elements */
        .btn {
            padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer;
            font-size: 13px; display: inline-flex; align-items: center; gap: 8px; transition: background 0.2s;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #357abd; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-secondary { background-color: #9e9e9e; color: white; }
        .btn-icon-only { background: none; border: none; color: #666; font-size: 16px; padding: 5px; }
        .btn-icon-only:hover { color: var(--primary-color); }

        .data-card {
            background: white; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden; margin-bottom: 20px;
        }

        table { width: 100%; border-collapse: collapse; }
        th {
            text-align: left; padding: 12px 15px; background-color: #f8f9fa;
            border-bottom: 2px solid var(--border-color); font-size: 12px; font-weight: 600; color: #555;
            position: sticky; top: 0; z-index: 5; white-space: nowrap;
        }
        td { padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 13px; vertical-align: middle; }
        tr.edit-mode { background-color: var(--edit-mode-bg) !important; }
        tr:hover { background-color: var(--row-hover); }

        .form-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .form-input:disabled { background-color: #f0f0f0; color: #666; cursor: not-allowed; }
        .error-msg { color: var(--danger-color); font-size: 12px; margin-top: 4px; display: none; }

        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--inactive-toggle); transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--active-toggle); }
        input:checked + .slider:before { transform: translateX(20px); }

        .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .status-active { background-color: #e8f5e9; color: #2e7d32; }
        .status-inactive { background-color: #f5f5f5; color: #616161; }
        
        /* Validation Highlights */
        .cell-pass { background-color: var(--cell-pass); color: #155724; font-weight: 600;}
        .cell-fail { background-color: var(--cell-fail); color: #721c24; font-weight: 600;}

        /* Assign Lab Properties Specifics */
        .alp-layout { display: flex; flex-direction: column; gap: 20px; }
        .alp-header-card { background: white; padding: 20px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .alp-field-row { display: flex; gap: 30px; margin-bottom: 15px; }
        .alp-field-group { flex: 1; }
        .alp-label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px; }
        .alp-textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background: #f9f9f9; font-size: 13px; resize: none; }
        
        .tab-container { margin-top: 20px; border-bottom: 1px solid #ddd; }
        .tab { padding: 10px 20px; cursor: pointer; font-weight: 500; color: #666; display: inline-block; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: var(--primary-color); color: var(--primary-color); }

        /* Settings Card */
        .settings-card { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); max-width: 800px; }
        .permission-section-title { background-color: #f8f9fa; padding: 10px; font-weight: 600; border-bottom: 2px solid #e0e0e0; margin-top: 20px; color: #555; }
        .permission-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .perm-info { font-size: 14px; color: #444; }
        .perm-desc { font-size: 12px; color: #888; margin-top: 4px; }

        /* Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal { background: white; border-radius: 8px; width: 600px; max-width: 90%; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: 600; font-size: 16px; }
        .modal-body { padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; text-align: right; }

        /* Toast */
        .toast {
            position: fixed; bottom: 30px; right: 30px; background-color: #323232; color: white; padding: 12px 24px;
            border-radius: 4px; font-size: 14px; opacity: 0; transform: translateY(20px); transition: all 0.3s; z-index: 2000;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-area" id="logo-area">
            <div class="logo-text" id="default-logo">e <span>QLM</span></div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link active" id="nav-dashboard" onclick="switchView('view-dashboard', this)"><i class="fas fa-chart-bar nav-icon"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"><i class="fas fa-flask nav-icon"></i> LabWorks <i class="fas fa-chevron-left nav-arrow"></i></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="toggleSubmenu('user-submenu')"><i class="fas fa-users nav-icon"></i> User Management <i class="fas fa-chevron-down nav-arrow"></i></a>
                <ul class="submenu" id="user-submenu">
                     <li class="submenu-item" onclick="switchView('view-roles', null, this)"><i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Roles</li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="toggleSubmenu('config-submenu')">
                    <i class="fas fa-cog nav-icon"></i> Configuration <i class="fas fa-chevron-down nav-arrow"></i>
                </a>
                <ul class="submenu" id="config-submenu">
                    <li class="submenu-item" onclick="switchView('view-app-settings', null, this)"><i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Application Settings</li>
                    <li class="submenu-item"><i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Workflows</li>
                    <li class="submenu-item" onclick="toggleSubmenu('library-submenu')">
                        <i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Library 
                        <i class="fas fa-chevron-down" style="font-size: 8px; margin-left: auto;"></i>
                    </li>
                    <ul class="submenu" id="library-submenu" style="padding-left: 20px; background-color: #f1f1f1;">
                        <li class="submenu-item" onclick="switchView('view-color-library', null, this)">Color</li>
                        <li class="submenu-item" onclick="switchView('view-profile-library', null, this)">Profile</li>
                        <li class="submenu-item" onclick="switchView('view-placeholder', null, this, 'Line Library')">Line</li>
                        <li class="submenu-item" onclick="switchView('view-placeholder', null, this, 'Length Library')">Length</li>
                        <li class="submenu-item" onclick="switchView('view-assign-lab', null, this)">Assign Lab Properties</li>
                    </ul>
                    <li class="submenu-item"><i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Email Templates</li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link"><i class="fas fa-file-alt nav-icon"></i> Reports <i class="fas fa-chevron-left nav-arrow"></i></a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="page-title" id="page-title-display">Plant Dashboard</div>
            <div class="header-actions">
                <i class="fas fa-search header-icon"></i>
                <i class="fas fa-expand header-icon"></i>
                <i class="fas fa-bars header-icon"></i>
                <div class="user-profile">SM</div>
            </div>
        </header>

        <!-- Body -->
        <div class="content-body" id="main-scroll-area">
            
            <!-- VIEW: DASHBOARD ROOTS -->
            <div id="view-dashboard" class="view-section active-view">
                <div class="dashboard-container">
                    <div class="plant-tile" onclick="switchView('view-plant-winchester')">
                        <div class="tile-name">WINCHESTER</div>
                        <i class="fas fa-industry tile-icon"></i>
                    </div>
                    <div class="plant-tile" style="opacity: 0.6; cursor: default;">
                        <div class="tile-name">FERNLEY</div>
                        <i class="fas fa-industry tile-icon"></i>
                    </div>
                </div>
            </div>

            <!-- VIEW: WINCHESTER -->
            <div id="view-plant-winchester" class="view-section">
                <div class="breadcrumb-nav">
                    <span onclick="switchView('view-dashboard')">Dashboard</span> > Winchester
                </div>
                <div class="dashboard-container">
                    <div class="plant-tile" onclick="switchView('view-section-decking')">
                        <div class="tile-name">Decking</div>
                        <i class="fas fa-layer-group tile-icon"></i>
                    </div>
                </div>
            </div>

            <!-- VIEW: DECKING -->
            <div id="view-section-decking" class="view-section">
                <div class="breadcrumb-nav">
                    <span onclick="switchView('view-dashboard')">Dashboard</span> > 
                    <span onclick="switchView('view-plant-winchester')">Winchester</span> > Decking
                </div>
                <div class="dashboard-container">
                    <div class="plant-tile" onclick="switchView('view-buildings')">
                        <div class="tile-name">Building 1</div>
                        <i class="fas fa-building tile-icon"></i>
                    </div>
                    <div class="plant-tile" onclick="switchView('view-buildings')">
                        <div class="tile-name">Building 4</div>
                        <i class="fas fa-building tile-icon"></i>
                    </div>
                    <div class="plant-tile" onclick="switchView('view-buildings')">
                        <div class="tile-name">Building 6</div>
                        <i class="fas fa-building tile-icon"></i>
                    </div>
                </div>
            </div>

             <!-- VIEW: BUILDINGS (Intermediate) -->
             <div id="view-buildings" class="view-section">
                <div class="breadcrumb-nav">
                    <span onclick="switchView('view-dashboard')">Dashboard</span> > 
                    <span onclick="switchView('view-plant-winchester')">Winchester</span> > 
                    <span onclick="switchView('view-section-decking')">Decking</span> > Building Selection
                </div>
                <div class="dashboard-container">
                    <div class="plant-tile" onclick="switchView('view-embossing-dashboard')">
                        <div class="tile-name">Embossing</div>
                        <i class="fas fa-stamp tile-icon"></i>
                    </div>
                </div>
            </div>

            <!-- VIEW: EMBOSSING DASHBOARD -->
            <div id="view-embossing-dashboard" class="view-section">
                <div class="breadcrumb-nav">
                    <!-- Static Full Path as requested -->
                    <span onclick="switchView('view-dashboard')">Dashboard</span> > 
                    <span onclick="switchView('view-plant-winchester')">Winchester</span> > 
                    <span onclick="switchView('view-section-decking')">Decking</span> > 
                    <span onclick="switchView('view-buildings')">Building 1</span> > Embossing
                </div>
                <div class="module-header">
                    <h2 class="module-title">Embossing Dashboard</h2>
                    <button class="btn btn-primary" id="add-dash-btn" onclick="startAddDashboardRow()">
                        <i class="fas fa-plus"></i> Add New Record
                    </button>
                </div>
                <div class="data-card">
                    <table>
                        <thead>
                            <tr>
                                <th>Action</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Line</th>
                                <th>Profile</th>
                                <th>Color</th>
                                <th>Length</th>
                                <th>Measure 1</th>
                                <th>Measure 2</th>
                                <th>Measure 3</th>
                                <th>Average</th>
                                <th>Created By</th>
                            </tr>
                        </thead>
                        <tbody id="embossing-table-body">
                            <!-- JS Generated -->
                        </tbody>
                    </table>
                </div>
                 <div style="height: 50px;"></div>
            </div>


            <!-- VIEW: COLOR LIBRARY -->
            <div id="view-color-library" class="view-section">
                <div class="module-header">
                    <h2 class="module-title">Color Library</h2>
                    <button class="btn btn-primary" id="add-btn" onclick="startAddNew()">
                        <i class="fas fa-plus"></i> Add New Color
                    </button>
                </div>
                <div class="data-card">
                    <table>
                        <thead>
                            <tr>
                                <th width="10%">SL. No.</th>
                                <th width="35%">Color Name</th>
                                <th width="20%">Status</th>
                                <th width="15%" style="text-align: center;">History</th>
                                <th width="20%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="color-table-body"></tbody>
                    </table>
                </div>
                <div style="height: 50px;"></div>
            </div>

            <!-- VIEW: PROFILE LIBRARY -->
            <div id="view-profile-library" class="view-section">
                <div class="module-header">
                    <h2 class="module-title">Profile Library</h2>
                    <button class="btn btn-primary" id="add-profile-btn" onclick="startAddNewProfile()">
                        <i class="fas fa-plus"></i> Add New Profile
                    </button>
                </div>
                <div class="data-card">
                    <table>
                        <thead>
                            <tr>
                                <th width="10%">SL. No.</th>
                                <th width="35%">Profile Name</th>
                                <th width="20%">Status</th>
                                <th width="15%" style="text-align: center;">History</th>
                                <th width="20%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="profile-table-body"></tbody>
                    </table>
                </div>
                <div style="height: 50px;"></div>
            </div>

            <!-- VIEW: ASSIGN LAB PROPERTIES -->
            <div id="view-assign-lab" class="view-section">
                <div class="module-header">
                    <h2 class="module-title">Assign Lab Properties</h2>
                </div>
                
                <div class="alp-layout">
                    <!-- Selector Card -->
                    <div class="alp-header-card">
                        <div class="alp-field-row">
                            <div class="alp-field-group">
                                <label class="alp-label">Select Lab <span style="color:red">*</span></label>
                                <select class="form-input" id="lab-selector" onchange="handleLabSelection()">
                                    <option value="">-- Select Lab --</option>
                                    <!-- Populated by JS -->
                                </select>
                            </div>
                        </div>
                        <div class="alp-field-group">
                            <label class="alp-label">Affected Locations</label>
                            <textarea class="alp-textarea" id="affected-locations" readonly></textarea>
                        </div>
                    </div>

                    <!-- Config Table Section (Hidden by default) -->
                    <div id="lab-config-section" style="display:none;">
                        <div class="tab-container">
                            <div class="tab active">Configuration</div>
                        </div>
                        <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
                            <button class="btn btn-primary" id="add-config-btn" onclick="startAddNewConfig()">
                                <i class="fas fa-plus"></i> Add Configuration
                            </button>
                        </div>
                        <div class="data-card" style="margin-top: 10px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th rowspan="2">Sl No.</th>
                                        <th rowspan="2">Profile</th>
                                        <th rowspan="2">Color</th>
                                        <th colspan="2" style="text-align:center; border-bottom: 1px solid #ddd;">Average</th>
                                        <th rowspan="2">Status</th>
                                        <th rowspan="2" style="text-align: center;">History</th>
                                        <th rowspan="2">Action</th>
                                    </tr>
                                    <tr>
                                        <th>Min Value</th>
                                        <th>Max Value</th>
                                    </tr>
                                </thead>
                                <tbody id="config-table-body"></tbody>
                            </table>
                        </div>
                         <div style="height: 50px;"></div>
                    </div>
                </div>
            </div>

            <!-- VIEW: APPLICATION SETTINGS -->
            <div id="view-app-settings" class="view-section">
                <div class="module-header"><h2 class="module-title">Application Settings</h2></div>
                <div class="settings-card">
                    <div class="form-group">
                        <label class="form-label">Software Logo Update</label>
                        <input type="file" id="logo-upload" accept="image/*" class="form-input" onchange="handleLogoUpload(event)">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="showToast('Settings Saved', 'success')">Save Settings</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: ROLES -->
            <div id="view-roles" class="view-section">
                <div class="module-header"><h2 class="module-title">User Roles</h2></div>
                <div class="settings-card">
                    <div style="margin-bottom: 10px;">
                        <h3 style="margin-bottom: 5px; font-size: 16px;">Role Permissions</h3>
                        <p style="color: #666; font-size: 13px;">Simulate user permissions.</p>
                    </div>

                    <div class="permission-section-title">Color Library</div>
                    <div class="permission-item">
                        <div class="perm-info">Create (New)</div>
                        <label class="switch"><input type="checkbox" id="perm-new" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>
                    <div class="permission-item">
                        <div class="perm-info">Edit</div>
                        <label class="switch"><input type="checkbox" id="perm-edit" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>
                     <div class="permission-item">
                        <div class="perm-info">Delete</div>
                        <label class="switch"><input type="checkbox" id="perm-delete" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>

                    <div class="permission-section-title">Profile Library</div>
                    <div class="permission-item">
                        <div class="perm-info">Create (New)</div>
                        <label class="switch"><input type="checkbox" id="perm-profile-new" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>
                    <div class="permission-item">
                        <div class="perm-info">Edit</div>
                        <label class="switch"><input type="checkbox" id="perm-profile-edit" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>
                     <div class="permission-item">
                        <div class="perm-info">Delete</div>
                        <label class="switch"><input type="checkbox" id="perm-profile-delete" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>

                    <div class="permission-section-title">Lab Configuration</div>
                    <div class="permission-item">
                        <div class="perm-info">Create (New)</div>
                        <label class="switch"><input type="checkbox" id="perm-config-new" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>
                    <div class="permission-item">
                        <div class="perm-info">Edit</div>
                        <label class="switch"><input type="checkbox" id="perm-config-edit" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>
                    <div class="permission-item">
                        <div class="perm-info">Delete</div>
                        <label class="switch"><input type="checkbox" id="perm-config-delete" checked onchange="updatePermissions()"><span class="slider"></span></label>
                    </div>
                </div>
            </div>

            <!-- VIEW: GENERIC PLACEHOLDER -->
            <div id="view-placeholder" class="view-section">
                <div class="module-header"><h2 class="module-title" id="placeholder-title">Library</h2></div>
                <div class="data-card" style="padding: 40px; text-align: center; color: #999;">
                    <i class="fas fa-tools" style="font-size: 40px; margin-bottom: 15px;"></i>
                    <p>This module is currently under development.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="history-title">History</div>
                <i class="fas fa-times" style="cursor: pointer;" onclick="closeHistory()"></i>
            </div>
            <div class="modal-body">
                <table class="history-table">
                    <thead><tr><th>Date</th><th>Action</th><th>User</th><th>Details</th></tr></thead>
                    <tbody id="history-content"></tbody>
                </table>
            </div>
            <div class="modal-footer"><button class="btn btn-secondary" onclick="closeHistory()">Close</button></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">Message here</div>

    <script>
        // --- CONSTANTS ---
        const LAB_OPTIONS = [
            "Adhesive Weight", "Bow Results", "Bulge", "Embossing", "Flatness", 
            "Incoming Raw Material", "Load Testing", "Moisture", "Mono Color", "Offset", 
            "Peel Strength", "QC Checks", "QC Offline Sample Test", "Railing Color Dashboard", 
            "Shell Stock", "Shell Thickness", "Ski-tipping", "Streak Color", "Streaker Testing", 
            "Strength", "Surface Energy", "Thickness", "TSC", 
            "VMM Dimension Documentation Dashboard", "Width"
        ];

        const EMBOSSING_LOCATIONS = `Embossing (Fernley > Decking )
Embossing (Winchester > Decking > Building 1 )
Embossing (Winchester > Decking > Building 4 )
Embossing (Winchester > Decking > Building 6 )`;

        // --- STATE ---
        const state = {
            // Permissions
            permissions: { new: true, edit: true, delete: true },
            profilePermissions: { new: true, edit: true, delete: true },
            configPermissions: { new: true, edit: true, delete: true },

            // Libraries
            colors: [
                { id: 1, slNo: 1, name: 'Red', status: true, history: [] },
                { id: 2, slNo: 2, name: 'Green', status: true, history: [] },
                { id: 3, slNo: 3, name: 'Blue', status: true, history: [] }
            ],
            profiles: [
                { id: 101, slNo: 1, name: 'Standard', status: true, history: [] },
                { id: 102, slNo: 2, name: 'Heavy Duty', status: true, history: [] }
            ],
            
            // Lab Configurations { labName: [records] }
            labConfigs: {
                "Embossing": [
                    { id: 1001, slNo: 1, profileId: 101, colorId: 1, min: 10, max: 20, status: true, history: [] }
                ]
            },
            
            // Dashboard Data
            embossingData: [
                { id: 501, date: '2025-12-16', time: '10:00', line: 'Line A', profileId: 101, colorId: 1, length: '12ft', m1: 15, m2: 15, m3: 15, avg: 15, createdBy: 'John Doe' }
            ],

            // Edit States
            editingId: null, isCreating: false, nextSlNo: 4,
            editingProfileId: null, isCreatingProfile: false, nextProfileSlNo: 3,
            
            // Config Edit States
            selectedLab: "",
            editingConfigId: null, isCreatingConfig: false, nextConfigSlNo: 2,

            // Dashboard Edit States
            editingDashId: null, isCreatingDash: false
        };

        // Init History
        const initHistory = (item) => item.history.push({ date: getFormattedDate(), action: 'Created', user: 'Admin', details: 'Initial Load' });
        state.colors.forEach(initHistory);
        state.profiles.forEach(initHistory);
        state.labConfigs["Embossing"].forEach(initHistory);

        // --- DOM Elements ---
        const tableBody = document.getElementById('color-table-body');
        const profileTableBody = document.getElementById('profile-table-body');
        const configTableBody = document.getElementById('config-table-body');
        const dashTableBody = document.getElementById('embossing-table-body');
        const addBtn = document.getElementById('add-btn');
        const addProfileBtn = document.getElementById('add-profile-btn');
        const addConfigBtn = document.getElementById('add-config-btn');
        const addDashBtn = document.getElementById('add-dash-btn');
        const toast = document.getElementById('toast');
        const mainScrollArea = document.getElementById('main-scroll-area');

        // --- INIT ---
        function init() {
            // Populate Lab Dropdown
            const sel = document.getElementById('lab-selector');
            LAB_OPTIONS.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt; el.innerText = opt;
                sel.appendChild(el);
            });
            renderTable(); renderProfileTable(); renderConfigTable(); renderDashTable();
        }

        // --- Navigation ---
        function switchView(viewId, navElement, subNavElement, titleOverride) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            document.getElementById(viewId).classList.add('active-view');
            
            const titleMap = {
                'view-dashboard': 'Plant Dashboard',
                'view-plant-winchester': 'Plant Dashboard > Winchester',
                'view-section-decking': 'Winchester > Decking',
                'view-buildings': 'Decking > Buildings',
                'view-embossing-dashboard': 'Embossing Dashboard',
                'view-color-library': 'Color Library',
                'view-profile-library': 'Profile Library',
                'view-assign-lab': 'Assign Lab Properties',
                'view-app-settings': 'Application Settings',
                'view-roles': 'User Management',
                'view-placeholder': titleOverride || 'Library'
            };
            document.getElementById('page-title-display').innerText = titleMap[viewId] || 'Dashboard';
            if(viewId === 'view-placeholder' && titleOverride) document.getElementById('placeholder-title').innerText = titleOverride;

            if (navElement || subNavElement) {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.submenu-item').forEach(el => el.classList.remove('active-sub'));
                if (navElement) navElement.classList.add('active');
                if (subNavElement) subNavElement.classList.add('active-sub');
            }
        }
        function toggleSubmenu(id) {
            const el = document.getElementById(id);
            if (el.style.display === 'block') el.style.display = 'none'; else el.style.display = 'block';
        }

        // --- Assign Lab Properties Logic ---
        function handleLabSelection() {
            const val = document.getElementById('lab-selector').value;
            state.selectedLab = val;
            const locArea = document.getElementById('affected-locations');
            const configSec = document.getElementById('lab-config-section');

            // Reset States
            state.editingConfigId = null; state.isCreatingConfig = false;

            if (val === "Embossing") {
                locArea.value = EMBOSSING_LOCATIONS;
                configSec.style.display = 'block';
                // Initialize array if empty
                if(!state.labConfigs[val]) state.labConfigs[val] = [];
                // Set next SlNo based on existing
                const existing = state.labConfigs[val];
                state.nextConfigSlNo = existing.length > 0 ? Math.max(...existing.map(i=>i.slNo)) + 1 : 1;
                renderConfigTable();
            } else if (val) {
                locArea.value = "No specific locations mapped for this prototype.";
                configSec.style.display = 'block';
                if(!state.labConfigs[val]) state.labConfigs[val] = [];
                state.nextConfigSlNo = 1;
                renderConfigTable();
            } else {
                locArea.value = "";
                configSec.style.display = 'none';
            }
        }

        function renderConfigTable(scrollToBottom = false) {
            configTableBody.innerHTML = '';
            const data = state.labConfigs[state.selectedLab] || [];
            
            data.forEach(item => {
                const isEditing = state.editingConfigId === item.id;
                const tr = document.createElement('tr');
                if(isEditing) tr.className = 'edit-mode';
                
                const profName = state.profiles.find(p=>p.id==item.profileId)?.name || 'Unknown';
                const colName = state.colors.find(c=>c.id==item.colorId)?.name || 'Unknown';
                
                if(isEditing) {
                    // Edit Mode
                    const canDelete = state.configPermissions.delete;
                    tr.innerHTML = `
                        <td>${item.slNo}</td>
                        <td>${profName}</td>
                        <td>${colName}</td>
                        <td><input type="number" class="form-input" id="cfg-min-${item.id}" value="${item.min}"></td>
                        <td><input type="number" class="form-input" id="cfg-max-${item.id}" value="${item.max}"></td>
                        <td>
                            ${canDelete ? `
                            <label class="switch"><input type="checkbox" id="cfg-status-${item.id}" ${item.status?'checked':''}><span class="slider"></span></label>
                            ` : `<span class="status-badge ${item.status?'status-active':'status-inactive'}">${item.status?'Active':'Inactive'}</span>`}
                        </td>
                        <td style="text-align:center;"><i class="fas fa-history" style="cursor:pointer;" onclick="showHistory('config', ${item.id})"></i></td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="saveConfig(${item.id})">Update</button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelConfig()"><i class="fas fa-times"></i></button>
                        </td>
                    `;
                } else {
                    // View Mode
                    tr.innerHTML = `
                        <td>${item.slNo}</td>
                        <td>${profName}</td>
                        <td>${colName}</td>
                        <td>${item.min}</td>
                        <td>${item.max}</td>
                        <td><span class="status-badge ${item.status?'status-active':'status-inactive'}">${item.status?'Active':'Inactive'}</span></td>
                        <td style="text-align:center;"><i class="fas fa-history" style="cursor:pointer;" onclick="showHistory('config', ${item.id})"></i></td>
                        <td>
                             ${state.configPermissions.edit ? 
                                `<button class="btn btn-icon-only" onclick="startEditConfig(${item.id})"><i class="fas fa-pencil-alt"></i></button>` : 
                                '<span style="color:#ccc; font-size:12px;">View Only</span>'
                            }
                        </td>
                    `;
                }
                configTableBody.appendChild(tr);
            });

            // New Row
            if (state.isCreatingConfig) {
                const tr = document.createElement('tr');
                tr.className = 'edit-mode';
                // Only show unmapped combinations or handle dupe check on save
                tr.innerHTML = `
                    <td>${state.nextConfigSlNo}</td>
                    <td>${generateProfileDropdown('new-cfg-profile')}</td>
                    <td>${generateColorDropdown('new-cfg-color')}</td>
                    <td><input type="number" class="form-input" id="new-cfg-min" placeholder="Min"></td>
                    <td><input type="number" class="form-input" id="new-cfg-max" placeholder="Max"></td>
                    <td><span class="status-badge status-active">Active</span></td>
                    <td style="text-align:center;"><i class="fas fa-history" style="color:#ccc;"></i></td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="saveNewConfig()"><i class="fas fa-check"></i> Save</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelConfig()"><i class="fas fa-times"></i></button>
                        <div class="error-msg" id="new-cfg-error"></div>
                    </td>
                `;
                configTableBody.appendChild(tr);
                if(scrollToBottom) setTimeout(() => { mainScrollArea.scrollTop = mainScrollArea.scrollHeight; }, 100);
            }
        }

        function generateProfileDropdown(id) {
            let html = `<select class="form-input" id="${id}"><option value="">Select Profile</option>`;
            state.profiles.filter(p=>p.status).forEach(p => { html += `<option value="${p.id}">${p.name}</option>`; });
            html += `</select>`;
            return html;
        }
        function generateColorDropdown(id) {
            let html = `<select class="form-input" id="${id}"><option value="">Select Color</option>`;
            state.colors.filter(c=>c.status).forEach(c => { html += `<option value="${c.id}">${c.name}</option>`; });
            html += `</select>`;
            return html;
        }

        function startAddNewConfig() {
            if(state.editingConfigId) cancelConfig();
            state.isCreatingConfig = true;
            renderConfigTable(true);
        }
        function startEditConfig(id) {
            state.isCreatingConfig = false;
            state.editingConfigId = id;
            renderConfigTable();
        }
        function cancelConfig() {
            state.isCreatingConfig = false;
            state.editingConfigId = null;
            renderConfigTable();
        }
        function saveNewConfig() {
            const pId = document.getElementById('new-cfg-profile').value;
            const cId = document.getElementById('new-cfg-color').value;
            const min = document.getElementById('new-cfg-min').value;
            const max = document.getElementById('new-cfg-max').value;
            const err = document.getElementById('new-cfg-error');

            if(!pId || !cId) { showInlineError(err, "Profile & Color required"); return; }
            
            // Check Duplicate: Ensure Profile+Color combination is unique
            const exists = state.labConfigs[state.selectedLab].some(i => i.profileId == pId && i.colorId == cId);
            if(exists) { showInlineError(err, "Combination already exists"); return; }

            const newRec = {
                id: Date.now(), slNo: state.nextConfigSlNo, profileId: pId, colorId: cId, min: min, max: max, status: true,
                history: [{ date: getFormattedDate(), action: 'Created', user: 'Demo', details: 'Status: Active' }]
            };
            state.labConfigs[state.selectedLab].push(newRec);
            state.nextConfigSlNo++;
            state.isCreatingConfig = false;
            renderConfigTable(true);
            showToast("Configuration Created", "success");
        }
        function saveConfig(id) {
            const rec = state.labConfigs[state.selectedLab].find(i=>i.id===id);
            const min = document.getElementById(`cfg-min-${id}`).value;
            const max = document.getElementById(`cfg-max-${id}`).value;
            const statusBox = document.getElementById(`cfg-status-${id}`);
            
            let newStatus = rec.status;
            if(state.configPermissions.delete && statusBox) newStatus = statusBox.checked;

            rec.min = min; rec.max = max; rec.status = newStatus;
            rec.history.unshift({ date: getFormattedDate(), action: 'Updated', user: 'Demo', details: 'Values updated' });
            
            state.editingConfigId = null;
            renderConfigTable();
            showToast("Updated", "success");
        }

        // --- Embossing Dashboard Logic ---
        function renderDashTable() {
            dashTableBody.innerHTML = '';
            
            // New Row at TOP
             if (state.isCreatingDash) {
                const tr = document.createElement('tr');
                tr.className = 'edit-mode';
                // Active Configs for Embossing
                const activeConfigs = (state.labConfigs["Embossing"] || []).filter(c => c.status);
                // Extract unique profiles and colors from config
                const configProfiles = [...new Set(activeConfigs.map(c => c.profileId))];
                const configColors = [...new Set(activeConfigs.map(c => c.colorId))];

                // Dropdowns with NO Auto-Fill (Empty first option)
                let pOpts = `<select class="form-input" id="dash-new-profile"><option value="">Select Profile</option>`;
                configProfiles.forEach(pid => { 
                    const p = state.profiles.find(x=>x.id==pid);
                    if(p) pOpts += `<option value="${p.id}">${p.name}</option>`; 
                });
                pOpts += `</select>`;

                let cOpts = `<select class="form-input" id="dash-new-color"><option value="">Select Color</option>`;
                configColors.forEach(cid => { 
                    const c = state.colors.find(x=>x.id==cid);
                    if(c) cOpts += `<option value="${c.id}">${c.name}</option>`; 
                });
                cOpts += `</select>`;

                tr.innerHTML = `
                    <td>
                        <button class="btn btn-success btn-sm" onclick="saveDashRow()"><i class="fas fa-check"></i></button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelDashRow()"><i class="fas fa-times"></i></button>
                    </td>
                    <td>${getFormattedDate().split(' ')[0]}</td>
                    <td>${getFormattedDate().split(' ')[1]}</td>
                    <td><select class="form-input" id="dash-new-line"><option value="">Select Line</option><option>Line A</option><option>Line B</option></select></td>
                    <td>${pOpts}</td>
                    <td>${cOpts}</td>
                    <td><select class="form-input" id="dash-new-len"><option value="">Select Length</option><option>10ft</option><option>12ft</option></select></td>
                    <td><input type="number" class="form-input" id="d-m1" oninput="calcAvg()"></td>
                    <td><input type="number" class="form-input" id="d-m2" oninput="calcAvg()"></td>
                    <td><input type="number" class="form-input" id="d-m3" oninput="calcAvg()"></td>
                    <td><span id="d-avg" style="font-weight:bold;">-</span></td>
                    <td>Demo User</td>
                `;
                dashTableBody.appendChild(tr);
            }

            state.embossingData.forEach(row => {
                const tr = document.createElement('tr');
                const isEditing = state.editingDashId === row.id;
                
                // Get display names
                const prof = state.profiles.find(p=>p.id == row.profileId)?.name;
                const col = state.colors.find(c=>c.id == row.colorId)?.name;
                
                // Validate Average against Config
                let cellClass = "";
                const config = (state.labConfigs["Embossing"] || []).find(c => c.profileId == row.profileId && c.colorId == row.colorId);
                if (config) {
                    if (row.avg >= parseFloat(config.min) && row.avg <= parseFloat(config.max)) cellClass = "cell-pass";
                    else cellClass = "cell-fail";
                }

                if (isEditing) {
                    // Populate dropdowns for edit with current value selected
                    const activeConfigs = (state.labConfigs["Embossing"] || []).filter(c => c.status);
                    const configProfiles = [...new Set(activeConfigs.map(c => c.profileId))];
                    const configColors = [...new Set(activeConfigs.map(c => c.colorId))];

                    let pOpts = `<select class="form-input" id="edit-dash-profile">`;
                    configProfiles.forEach(pid => { 
                        const p = state.profiles.find(x=>x.id==pid);
                        if(p) pOpts += `<option value="${p.id}" ${p.id==row.profileId?'selected':''}>${p.name}</option>`; 
                    });
                    pOpts += `</select>`;

                    let cOpts = `<select class="form-input" id="edit-dash-color">`;
                    configColors.forEach(cid => { 
                        const c = state.colors.find(x=>x.id==cid);
                        if(c) cOpts += `<option value="${c.id}" ${c.id==row.colorId?'selected':''}>${c.name}</option>`; 
                    });
                    cOpts += `</select>`;

                    tr.className = 'edit-mode';
                    tr.innerHTML = `
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="updateDashRow(${row.id})">Save</button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelEditDash()">X</button>
                        </td>
                        <td>${row.date}</td>
                        <td>${row.time}</td>
                        <td><select class="form-input" id="edit-dash-line"><option ${row.line=='Line A'?'selected':''}>Line A</option><option ${row.line=='Line B'?'selected':''}>Line B</option></select></td>
                        <td>${pOpts}</td>
                        <td>${cOpts}</td>
                        <td><select class="form-input" id="edit-dash-len"><option ${row.length=='10ft'?'selected':''}>10ft</option><option ${row.length=='12ft'?'selected':''}>12ft</option></select></td>
                        <td><input type="number" class="form-input" id="edit-d-m1" value="${row.m1}" oninput="calcEditAvg(${row.id})"></td>
                        <td><input type="number" class="form-input" id="edit-d-m2" value="${row.m2}" oninput="calcEditAvg(${row.id})"></td>
                        <td><input type="number" class="form-input" id="edit-d-m3" value="${row.m3}" oninput="calcEditAvg(${row.id})"></td>
                        <td><span id="edit-d-avg-${row.id}" style="font-weight:bold;">${row.avg}</span></td>
                        <td>${row.createdBy}</td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>
                             <button class="btn btn-icon-only" onclick="showHistory('dash', ${row.id})"><i class="fas fa-history"></i></button>
                             <button class="btn btn-icon-only" onclick="startEditDash(${row.id})"><i class="fas fa-pencil-alt"></i></button>
                             <button class="btn btn-icon-only" style="color:var(--danger-color)" onclick="deleteDashRow(${row.id})"><i class="fas fa-trash"></i></button>
                        </td>
                        <td>${row.date}</td>
                        <td>${row.time}</td>
                        <td>${row.line}</td>
                        <td>${prof}</td>
                        <td>${col}</td>
                        <td>${row.length}</td>
                        <td>${row.m1}</td>
                        <td>${row.m2}</td>
                        <td>${row.m3}</td>
                        <td class="${cellClass}">${row.avg}</td>
                        <td>${row.createdBy}</td>
                    `;
                }
                dashTableBody.appendChild(tr);
            });
        }

        function startAddDashboardRow() {
            if(state.editingDashId) cancelEditDash();
            state.isCreatingDash = true;
            renderDashTable();
        }
        function cancelDashRow() {
            state.isCreatingDash = false;
            renderDashTable();
        }
        function startEditDash(id) {
            state.isCreatingDash = false;
            state.editingDashId = id;
            renderDashTable();
        }
        function cancelEditDash() {
            state.editingDashId = null;
            renderDashTable();
        }
        function deleteDashRow(id) {
            if(confirm("Delete this record?")) {
                state.embossingData = state.embossingData.filter(d => d.id !== id);
                renderDashTable();
                showToast("Record Deleted", "success");
            }
        }

        function calcAvg() {
            const m1 = parseFloat(document.getElementById('d-m1').value) || 0;
            const m2 = parseFloat(document.getElementById('d-m2').value) || 0;
            const m3 = parseFloat(document.getElementById('d-m3').value) || 0;
            const avg = ((m1+m2+m3)/3).toFixed(2);
            const el = document.getElementById('d-avg');
            el.innerText = avg;
            // Live validation visual
            validateAvgLive(avg, 'dash-new-profile', 'dash-new-color', el);
        }

        function calcEditAvg(id) {
            const m1 = parseFloat(document.getElementById('edit-d-m1').value) || 0;
            const m2 = parseFloat(document.getElementById('edit-d-m2').value) || 0;
            const m3 = parseFloat(document.getElementById('edit-d-m3').value) || 0;
            const avg = ((m1+m2+m3)/3).toFixed(2);
            const el = document.getElementById(`edit-d-avg-${id}`);
            el.innerText = avg;
            validateAvgLive(avg, 'edit-dash-profile', 'edit-dash-color', el);
        }

        function validateAvgLive(avgVal, profId, colId, el) {
            const pid = document.getElementById(profId).value;
            const cid = document.getElementById(colId).value;
            if(pid && cid) {
                const config = (state.labConfigs["Embossing"] || []).find(c => c.profileId == pid && c.colorId == cid);
                if(config) {
                    const min = parseFloat(config.min); const max = parseFloat(config.max);
                    const val = parseFloat(avgVal);
                    if(val >= min && val <= max) { el.style.color = "green"; } else { el.style.color = "red"; }
                }
            }
        }

        function saveDashRow() {
            const line = document.getElementById('dash-new-line').value;
            const pid = document.getElementById('dash-new-profile').value;
            const cid = document.getElementById('dash-new-color').value;
            const len = document.getElementById('dash-new-len').value;
            const m1Val = document.getElementById('d-m1').value;
            const m2Val = document.getElementById('d-m2').value;
            const m3Val = document.getElementById('d-m3').value;
            
            // Mandatory Check
            if(!line || !pid || !cid || !len || m1Val==="" || m2Val==="" || m3Val==="") { 
                alert("All fields are mandatory."); return; 
            }

            const m1 = parseFloat(m1Val); const m2 = parseFloat(m2Val); const m3 = parseFloat(m3Val);
            const avg = parseFloat(((m1+m2+m3)/3).toFixed(2));

            state.embossingData.unshift({
                id: Date.now(), date: getFormattedDate().split(' ')[0], time: getFormattedDate().split(' ')[1],
                line, profileId: pid, colorId: cid, length: len,
                m1, m2, m3, avg, createdBy: 'Demo User'
            });
            state.isCreatingDash = false;
            renderDashTable();
            showToast("Record Added", "success");
        }

        function updateDashRow(id) {
            const row = state.embossingData.find(r => r.id === id);
            const line = document.getElementById('edit-dash-line').value;
            const pid = document.getElementById('edit-dash-profile').value;
            const cid = document.getElementById('edit-dash-color').value;
            const len = document.getElementById('edit-dash-len').value;
            const m1Val = document.getElementById('edit-d-m1').value;
            const m2Val = document.getElementById('edit-d-m2').value;
            const m3Val = document.getElementById('edit-d-m3').value;

             if(!line || !pid || !cid || !len || m1Val==="" || m2Val==="" || m3Val==="") { 
                alert("All fields are mandatory."); return; 
            }

            row.line = line; row.profileId = pid; row.colorId = cid; row.length = len;
            row.m1 = parseFloat(m1Val); row.m2 = parseFloat(m2Val); row.m3 = parseFloat(m3Val);
            row.avg = parseFloat(((row.m1+row.m2+row.m3)/3).toFixed(2));
            
            state.editingDashId = null;
            renderDashTable();
            showToast("Record Updated", "success");
        }

        // --- Standard Lib Logic (Color/Profile) ---
        function renderTable() {
             // ... (Reused from previous, stripped for brevity but logic remains same) ...
             // Re-implementing simplified version
             tableBody.innerHTML = '';
             state.colors.forEach(c => {
                 const isEdit = state.editingId === c.id;
                 const tr = document.createElement('tr');
                 if(isEdit) {
                     tr.innerHTML = `<td>${c.slNo}</td><td><input class="form-input" value="${c.name}" disabled></td>
                     <td><label class="switch"><input type="checkbox" id="e-status-${c.id}" ${c.status?'checked':''} ${!state.permissions.delete?'disabled':''}><span class="slider"></span></label></td>
                     <td style="text-align:center;"><i class="fas fa-history"></i></td>
                     <td><button class="btn btn-primary btn-sm" onclick="saveColor(${c.id})">Update</button> <button class="btn btn-secondary btn-sm" onclick="state.editingId=null;renderTable()">X</button></td>`;
                 } else {
                     tr.innerHTML = `<td>${c.slNo}</td><td>${c.name}</td><td><span class="status-badge ${c.status?'status-active':'status-inactive'}">${c.status?'Active':'Inactive'}</span></td>
                     <td style="text-align:center;"><i class="fas fa-history" onclick="showHistory('color',${c.id})"></i></td>
                     <td>${state.permissions.edit ? `<button class="btn btn-icon-only" onclick="state.editingId=${c.id};renderTable()"><i class="fas fa-pencil-alt"></i></button>` : ''}</td>`;
                 }
                 tableBody.appendChild(tr);
             });
             if(state.isCreating) {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `<td>${state.nextSlNo}</td><td><input class="form-input" id="new-c-name"></td><td>Active</td><td></td>
                 <td><button class="btn btn-success btn-sm" onclick="saveNewColor()">Save</button> <button class="btn btn-secondary btn-sm" onclick="state.isCreating=false;renderTable()">X</button></td>`;
                 tableBody.appendChild(tr);
             }
        }
        function startAddNew() { state.editingId=null; state.isCreating=true; renderTable(); }
        function saveNewColor() {
            const name = document.getElementById('new-c-name').value;
            if(!name) return;
            state.colors.push({ id: Date.now(), slNo: state.nextSlNo++, name, status: true, history: [] });
            state.isCreating=false; renderTable();
        }
        function saveColor(id) {
            const c = state.colors.find(x=>x.id==id);
            const st = document.getElementById(`e-status-${id}`);
            if(st) c.status = st.checked;
            state.editingId=null; renderTable();
        }

        function renderProfileTable() {
             profileTableBody.innerHTML = '';
             state.profiles.forEach(p => {
                 const isEdit = state.editingProfileId === p.id;
                 const tr = document.createElement('tr');
                 if(isEdit) {
                     tr.innerHTML = `<td>${p.slNo}</td><td><input class="form-input" value="${p.name}" disabled></td>
                     <td><label class="switch"><input type="checkbox" id="ep-status-${p.id}" ${p.status?'checked':''} ${!state.profilePermissions.delete?'disabled':''}><span class="slider"></span></label></td>
                     <td style="text-align:center;"><i class="fas fa-history"></i></td>
                     <td><button class="btn btn-primary btn-sm" onclick="saveProfile(${p.id})">Update</button> <button class="btn btn-secondary btn-sm" onclick="state.editingProfileId=null;renderProfileTable()">X</button></td>`;
                 } else {
                     tr.innerHTML = `<td>${p.slNo}</td><td>${p.name}</td><td><span class="status-badge ${p.status?'status-active':'status-inactive'}">${p.status?'Active':'Inactive'}</span></td>
                     <td style="text-align:center;"><i class="fas fa-history" onclick="showHistory('profile',${p.id})"></i></td>
                     <td>${state.profilePermissions.edit ? `<button class="btn btn-icon-only" onclick="state.editingProfileId=${p.id};renderProfileTable()"><i class="fas fa-pencil-alt"></i></button>` : ''}</td>`;
                 }
                 profileTableBody.appendChild(tr);
             });
             if(state.isCreatingProfile) {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `<td>${state.nextProfileSlNo}</td><td><input class="form-input" id="new-p-name"></td><td>Active</td><td></td>
                 <td><button class="btn btn-success btn-sm" onclick="saveNewProfile()">Save</button> <button class="btn btn-secondary btn-sm" onclick="state.isCreatingProfile=false;renderProfileTable()">X</button></td>`;
                 profileTableBody.appendChild(tr);
             }
        }
        function startAddNewProfile() { state.editingProfileId=null; state.isCreatingProfile=true; renderProfileTable(); }
        function saveNewProfile() {
            const name = document.getElementById('new-p-name').value;
            if(!name) return;
            state.profiles.push({ id: Date.now(), slNo: state.nextProfileSlNo++, name, status: true, history: [] });
            state.isCreatingProfile=false; renderProfileTable();
        }
        function saveProfile(id) {
            const p = state.profiles.find(x=>x.id==id);
            const st = document.getElementById(`ep-status-${id}`);
            if(st) p.status = st.checked;
            state.editingProfileId=null; renderProfileTable();
        }

        // --- Utils ---
        function updatePermissions() {
            state.permissions.new = document.getElementById('perm-new').checked;
            state.permissions.edit = document.getElementById('perm-edit').checked;
            state.permissions.delete = document.getElementById('perm-delete').checked;
            
            state.profilePermissions.new = document.getElementById('perm-profile-new').checked;
            state.profilePermissions.edit = document.getElementById('perm-profile-edit').checked;
            state.profilePermissions.delete = document.getElementById('perm-profile-delete').checked;

            state.configPermissions.new = document.getElementById('perm-config-new').checked;
            state.configPermissions.edit = document.getElementById('perm-config-edit').checked;
            state.configPermissions.delete = document.getElementById('perm-config-delete').checked;

            // UI Updates
            document.getElementById('add-btn').style.display = state.permissions.new ? 'inline-flex' : 'none';
            document.getElementById('add-profile-btn').style.display = state.profilePermissions.new ? 'inline-flex' : 'none';
            document.getElementById('add-config-btn').style.display = state.configPermissions.new ? 'inline-flex' : 'none';
            
            renderTable(); renderProfileTable(); renderConfigTable();
        }

        function showHistory(type, id) {
            let item;
            if(type=='color') item = state.colors.find(i=>i.id==id);
            if(type=='profile') item = state.profiles.find(i=>i.id==id);
            if(type=='config') item = state.labConfigs[state.selectedLab].find(i=>i.id==id);
            if(type=='dash') item = state.embossingData.find(i=>i.id==id); // Added history for dash
            
            // Mock dash history if array not initialized
            if(type=='dash' && !item.history) item.history = [{ date: item.date + ' ' + item.time, action: 'Created', user: item.createdBy, details: 'Record created' }];

            if(!item) return;

            document.getElementById('history-title').innerText = `History - ${type}`;
            const hb = document.getElementById('history-content'); hb.innerHTML = '';
            item.history.forEach(h => {
                hb.innerHTML += `<tr><td>${h.date}</td><td>${h.action}</td><td>${h.user}</td><td>${h.details}</td></tr>`;
            });
            document.getElementById('history-modal').style.display = 'flex';
        }
        function closeHistory() { document.getElementById('history-modal').style.display = 'none'; }
        function showInlineError(el, msg) { el.innerText = msg; el.style.display = 'block'; }
        function showToast(msg, type) { toast.innerText = msg; toast.className = `toast ${type} show`; setTimeout(() => toast.className = 'toast', 3000); }
        function getFormattedDate() {
            const now = new Date();
            const pad = n => n < 10 ? '0'+n : n;
            return `${pad(now.getDate())}-${['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][now.getMonth()]}-${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
        }
        function handleLogoUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    document.getElementById('logo-area').innerHTML = `<img src="${evt.target.result}" class="logo-img" alt="Logo">`;
                    showToast('Logo updated', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // Run
        init();
    </script>
</body>
</html>
