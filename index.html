<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eQLM - Prototype</title>
    <!-- Fonts and Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS Reset & Variables --- */
        :root {
            --primary-color: #4a90e2; /* Matches blue in screenshot */
            --header-height: 60px;
            --sidebar-width: 260px;
            --bg-color: #f4f6f8;
            --text-color: #333;
            --border-color: #e0e0e0;
            --success-color: #4caf50;
            --danger-color: #f44336;
            --active-toggle: #4caf50;
            --inactive-toggle: #ccc;
            --row-hover: #f9fafb;
            --edit-mode-bg: #E3F2FD;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #fff;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
            z-index: 10;
        }

        .logo-area {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding-left: 20px;
            border-bottom: 1px solid var(--border-color);
            overflow: hidden;
        }

        .logo-img {
            max-height: 40px;
            max-width: 100%;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #555;
        }

        .logo-text span {
            color: #8bc34a; /* QLM Greenish tone */
        }

        .nav-menu {
            list-style: none;
            padding-top: 20px;
            overflow-y: auto;
        }

        .nav-item {
            padding: 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            text-decoration: none;
            color: #666;
            font-size: 14px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            background-color: #f0f0f0;
            color: var(--primary-color);
        }

        .nav-link.active {
            background-color: #e8f0fe;
            color: var(--primary-color);
            border-left: 4px solid var(--primary-color);
        }

        .nav-icon {
            width: 20px;
            margin-right: 10px;
            text-align: center;
        }

        .nav-arrow {
            margin-left: auto;
            font-size: 10px;
        }

        /* Submenu */
        .submenu {
            list-style: none;
            background-color: #fafafa;
            display: none; /* Hidden by default */
        }

        .submenu.open {
            display: block;
        }

        .submenu-item {
            padding-left: 50px;
            padding-top: 10px;
            padding-bottom: 10px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .submenu-item:hover {
            color: var(--primary-color);
        }
        
        .submenu-item.active-sub {
            color: var(--primary-color);
            font-weight: 500;
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Header */
        .top-header {
            height: var(--header-height);
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .page-title {
            font-size: 18px;
            color: #444;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-icon {
            color: #777;
            font-size: 16px;
            cursor: pointer;
        }

        .user-profile {
            width: 35px;
            height: 35px;
            background-color: #4caf50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        /* Content Body */
        .content-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
        }

        /* Views */
        .view-section {
            display: none;
            height: 100%;
        }
        
        .view-section.active-view {
            display: block;
        }

        /* Dashboard View */
        .dashboard-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .plant-tile {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            width: 280px;
            height: 120px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .plant-tile:hover {
            transform: translateY(-5px);
        }

        .tile-name {
            font-size: 18px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .tile-icon {
            font-size: 40px;
            opacity: 0.3;
        }

        /* Module Header */
        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .module-title {
            font-size: 20px;
            font-weight: 500;
            color: #333;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #357abd;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-secondary {
            background-color: #9e9e9e;
            color: white;
        }
        
        .btn-icon-only {
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            padding: 5px;
        }
        
        .btn-icon-only:hover {
            color: var(--primary-color);
        }

        /* Data Table */
        .data-card {
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 15px;
            background-color: #f8f9fa;
            border-bottom: 2px solid var(--border-color);
            font-size: 13px;
            font-weight: 600;
            color: #555;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            vertical-align: middle;
        }

        tr.edit-mode {
            background-color: var(--edit-mode-bg) !important;
        }
        
        tr:hover {
            background-color: var(--row-hover);
        }

        /* Form Inputs */
        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-input:disabled {
            background-color: #f0f0f0;
            color: #666;
            cursor: not-allowed;
        }
        
        .error-msg {
            color: var(--danger-color);
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--inactive-toggle);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--active-toggle);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }
        
        /* Status Badge for Read-only */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-active { background-color: #e8f5e9; color: #2e7d32; }
        .status-inactive { background-color: #f5f5f5; color: #616161; }

        /* Actions Cell */
        .actions-cell {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Application Settings & Permission Card */
        .settings-card {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            max-width: 600px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        /* Roles Page Items */
        .permission-section-title {
            background-color: #f8f9fa;
            padding: 10px;
            font-weight: 600;
            border-bottom: 2px solid #e0e0e0;
            margin-top: 20px;
            color: #555;
        }
        
        .permission-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }
        .permission-item:last-child {
            border-bottom: none;
        }
        .perm-info {
            font-size: 14px;
            color: #444;
        }
        .perm-desc {
            font-size: 12px;
            color: #888;
            margin-top: 4px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title { font-weight: 600; font-size: 16px; }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            text-align: right;
        }

        .history-table th { background-color: #e3f2fd; }
        .history-table td { font-size: 12px; }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background-color: #323232;
            color: white;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            z-index: 2000;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }

    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-area" id="logo-area">
            <div class="logo-text" id="default-logo">e <span>QLM</span></div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link active" id="nav-dashboard" onclick="switchView('view-dashboard', this)"><i class="fas fa-chart-bar nav-icon"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link"><i class="fas fa-flask nav-icon"></i> LabWorks <i class="fas fa-chevron-left nav-arrow"></i></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="toggleSubmenu('user-submenu')"><i class="fas fa-users nav-icon"></i> User Management <i class="fas fa-chevron-down nav-arrow"></i></a>
                <ul class="submenu" id="user-submenu">
                     <li class="submenu-item" onclick="switchView('view-roles', null, this)"><i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Roles</li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link" onclick="toggleSubmenu('config-submenu')">
                    <i class="fas fa-cog nav-icon"></i> Configuration <i class="fas fa-chevron-down nav-arrow"></i>
                </a>
                <ul class="submenu" id="config-submenu">
                    <li class="submenu-item" onclick="switchView('view-app-settings', null, this)"><i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Application Settings</li>
                    <li class="submenu-item"><i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Workflows</li>
                    <li class="submenu-item" onclick="toggleSubmenu('library-submenu')">
                        <i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Library 
                        <i class="fas fa-chevron-down" style="font-size: 8px; margin-left: auto;"></i>
                    </li>
                    <ul class="submenu" id="library-submenu" style="padding-left: 20px; background-color: #f1f1f1;">
                        <li class="submenu-item" onclick="switchView('view-color-library', null, this)">Color</li>
                        <li class="submenu-item" onclick="switchView('view-profile-library', null, this)">Profile</li>
                        <li class="submenu-item" onclick="switchView('view-placeholder', null, this, 'Line Library')">Line</li>
                        <li class="submenu-item" onclick="switchView('view-placeholder', null, this, 'Length Library')">Length</li>
                        <li class="submenu-item" onclick="switchView('view-placeholder', null, this, 'Assign Lab Properties')">Assign Lab Properties</li>
                    </ul>
                    <li class="submenu-item"><i class="far fa-circle" style="font-size: 8px; margin-right: 10px;"></i> Email Templates</li>
                </ul>
            </li>
            <li class="nav-item">
                <a class="nav-link"><i class="fas fa-file-alt nav-icon"></i> Reports <i class="fas fa-chevron-left nav-arrow"></i></a>
            </li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="page-title" id="page-title-display">Plant Dashboard</div>
            <div class="header-actions">
                <i class="fas fa-search header-icon"></i>
                <i class="fas fa-expand header-icon"></i>
                <i class="fas fa-bars header-icon"></i>
                <div class="user-profile">SM</div>
            </div>
        </header>

        <!-- Body -->
        <div class="content-body" id="main-scroll-area">
            
            <!-- VIEW: DASHBOARD (Default) -->
            <div id="view-dashboard" class="view-section active-view">
                <div class="dashboard-container">
                    <div class="plant-tile" onclick="switchView('view-color-library', null, null)">
                        <div class="tile-name">FERNLEY</div>
                        <i class="fas fa-cog tile-icon"></i>
                    </div>
                    <div class="plant-tile">
                        <div class="tile-name">WINCHESTER</div>
                        <i class="fas fa-cog tile-icon"></i>
                    </div>
                </div>
            </div>

            <!-- VIEW: COLOR LIBRARY -->
            <div id="view-color-library" class="view-section">
                <div class="module-header">
                    <h2 class="module-title">Color Library</h2>
                    <button class="btn btn-primary" id="add-btn" onclick="startAddNew()">
                        <i class="fas fa-plus"></i> Add New Color
                    </button>
                </div>

                <div class="data-card">
                    <table>
                        <thead>
                            <tr>
                                <th width="10%">SL. No.</th>
                                <th width="35%">Color Name</th>
                                <th width="20%">Status</th>
                                <th width="15%" style="text-align: center;">History</th>
                                <th width="20%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="color-table-body">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Space to scroll -->
                <div style="height: 50px;"></div>
            </div>

            <!-- VIEW: PROFILE LIBRARY -->
            <div id="view-profile-library" class="view-section">
                <div class="module-header">
                    <h2 class="module-title">Profile Library</h2>
                    <button class="btn btn-primary" id="add-profile-btn" onclick="startAddNewProfile()">
                        <i class="fas fa-plus"></i> Add New Profile
                    </button>
                </div>

                <div class="data-card">
                    <table>
                        <thead>
                            <tr>
                                <th width="10%">SL. No.</th>
                                <th width="35%">Profile Name</th>
                                <th width="20%">Status</th>
                                <th width="15%" style="text-align: center;">History</th>
                                <th width="20%">Action</th>
                            </tr>
                        </thead>
                        <tbody id="profile-table-body">
                            <!-- Rows generated by JS -->
                        </tbody>
                    </table>
                </div>
                <div style="height: 50px;"></div>
            </div>

            <!-- VIEW: APPLICATION SETTINGS -->
            <div id="view-app-settings" class="view-section">
                <div class="module-header">
                    <h2 class="module-title">Application Settings</h2>
                </div>
                <div class="settings-card">
                    <div class="form-group">
                        <label class="form-label">Software Logo Update</label>
                        <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Upload an image to replace the top-left logo.</p>
                        <input type="file" id="logo-upload" accept="image/*" class="form-input" onchange="handleLogoUpload(event)">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="showToast('Settings Saved', 'success')">Save Settings</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: ROLES -->
            <div id="view-roles" class="view-section">
                <div class="module-header">
                    <h2 class="module-title">User Roles</h2>
                </div>
                <div class="settings-card">
                    <div style="margin-bottom: 10px;">
                        <h3 style="margin-bottom: 5px; font-size: 16px;">Role Permissions</h3>
                        <p style="color: #666; font-size: 13px;">
                            Toggle switches to simulate active user permissions for different modules.
                        </p>
                    </div>

                    <!-- COLOR LIBRARY PERMISSIONS -->
                    <div class="permission-section-title">Color Library Permissions</div>
                    <div class="permission-item">
                        <div class="perm-info">
                            <div>Create Permission (New)</div>
                            <div class="perm-desc">Allows user to add new colors.</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="perm-new" checked onchange="updatePermissions()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-item">
                        <div class="perm-info">
                            <div>Edit Permission</div>
                            <div class="perm-desc">Allows user to modify existing colors.</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="perm-edit" checked onchange="updatePermissions()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-item">
                        <div class="perm-info">
                            <div>Deactivate Permission (Delete)</div>
                            <div class="perm-desc">Allows user to toggle status (Active/Inactive).</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="perm-delete" checked onchange="updatePermissions()">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <!-- PROFILE LIBRARY PERMISSIONS -->
                    <div class="permission-section-title">Profile Library Permissions</div>
                    <div class="permission-item">
                        <div class="perm-info">
                            <div>Create Permission (New)</div>
                            <div class="perm-desc">Allows user to add new profiles.</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="perm-profile-new" checked onchange="updatePermissions()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-item">
                        <div class="perm-info">
                            <div>Edit Permission</div>
                            <div class="perm-desc">Allows user to modify existing profiles.</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="perm-profile-edit" checked onchange="updatePermissions()">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="permission-item">
                        <div class="perm-info">
                            <div>Deactivate Permission (Delete)</div>
                            <div class="perm-desc">Allows user to toggle status (Active/Inactive).</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="perm-profile-delete" checked onchange="updatePermissions()">
                            <span class="slider"></span>
                        </label>
                    </div>

                </div>
            </div>

            <!-- VIEW: GENERIC PLACEHOLDER -->
            <div id="view-placeholder" class="view-section">
                <div class="module-header">
                    <h2 class="module-title" id="placeholder-title">Library</h2>
                </div>
                <div class="data-card" style="padding: 40px; text-align: center; color: #999;">
                    <i class="fas fa-tools" style="font-size: 40px; margin-bottom: 15px;"></i>
                    <p>This module is currently under development.</p>
                </div>
            </div>

        </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="history-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="history-title">History</div>
                <i class="fas fa-times" style="cursor: pointer;" onclick="closeHistory()"></i>
            </div>
            <div class="modal-body">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Action</th>
                            <th>User</th>
                            <th>Changes</th>
                        </tr>
                    </thead>
                    <tbody id="history-content">
                        <!-- History items -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeHistory()">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">Message here</div>

    <script>
        // --- State Management ---
        const state = {
            // Permissions for Color Library
            permissions: {
                new: true,
                edit: true,
                delete: true
            },
            // Permissions for Profile Library
            profilePermissions: {
                new: true,
                edit: true,
                delete: true
            },
            
            // Color Data
            colors: [
                { id: 1, slNo: 1, name: 'Red', status: true, history: [] },
                { id: 2, slNo: 2, name: 'Green', status: true, history: [] },
                { id: 3, slNo: 3, name: 'Blue', status: true, history: [] },
                { id: 4, slNo: 4, name: 'Yellow', status: false, history: [] }
            ],
            editingId: null,
            isCreating: false,
            nextSlNo: 5,

            // Profile Data
            profiles: [
                { id: 101, slNo: 1, name: 'Standard Profile', status: true, history: [] },
                { id: 102, slNo: 2, name: 'Extended Profile', status: true, history: [] }
            ],
            editingProfileId: null,
            isCreatingProfile: false,
            nextProfileSlNo: 3
        };

        // Initialize history
        const initHistory = (item) => {
            item.history.push({
                date: '10-Dec-2025 10:00:00',
                action: 'Created',
                user: 'System Admin',
                details: 'Initial Load'
            });
        };
        state.colors.forEach(initHistory);
        state.profiles.forEach(initHistory);

        // --- DOM Elements ---
        const tableBody = document.getElementById('color-table-body');
        const profileTableBody = document.getElementById('profile-table-body');
        const addBtn = document.getElementById('add-btn');
        const addProfileBtn = document.getElementById('add-profile-btn');
        const toast = document.getElementById('toast');
        const mainScrollArea = document.getElementById('main-scroll-area');

        // --- Navigation Logic ---
        function switchView(viewId, navElement, subNavElement, titleOverride) {
            // Hide all views
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
            // Show target view
            document.getElementById(viewId).classList.add('active-view');
            
            // Update Headers
            const titleMap = {
                'view-dashboard': 'Plant Dashboard',
                'view-color-library': 'Color Library',
                'view-profile-library': 'Profile Library',
                'view-app-settings': 'Configuration Dashboard',
                'view-roles': 'User Management',
                'view-placeholder': titleOverride || 'Library'
            };
            document.getElementById('page-title-display').innerText = titleMap[viewId];
            if(viewId === 'view-placeholder' && titleOverride) {
                document.getElementById('placeholder-title').innerText = titleOverride;
            }

            // Update Nav Active State
            if (navElement || subNavElement) {
                document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.submenu-item').forEach(el => el.classList.remove('active-sub'));
                
                if (navElement) navElement.classList.add('active');
                if (subNavElement) {
                    subNavElement.classList.add('active-sub');
                }
            }
        }

        function toggleSubmenu(id) {
            const el = document.getElementById(id);
            if (el.style.display === 'block' || el.classList.contains('open')) {
                el.style.display = 'none';
                el.classList.remove('open');
            } else {
                el.style.display = 'block';
                el.classList.add('open');
            }
        }

        // --- Logo Upload Logic ---
        function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const logoArea = document.getElementById('logo-area');
                    logoArea.innerHTML = `<img src="${e.target.result}" class="logo-img" alt="Logo">`;
                    showToast('Logo updated successfully', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // --- Permissions Logic ---
        function updatePermissions() {
            // Update Color Permissions
            state.permissions.new = document.getElementById('perm-new').checked;
            state.permissions.edit = document.getElementById('perm-edit').checked;
            state.permissions.delete = document.getElementById('perm-delete').checked;

            // Update Profile Permissions
            state.profilePermissions.new = document.getElementById('perm-profile-new').checked;
            state.profilePermissions.edit = document.getElementById('perm-profile-edit').checked;
            state.profilePermissions.delete = document.getElementById('perm-profile-delete').checked;

            // Reset States
            state.editingId = null;
            state.isCreating = false;
            state.editingProfileId = null;
            state.isCreatingProfile = false;

            updateUIControls();
            renderTable();
            renderProfileTable();
        }

        function updateUIControls() {
            addBtn.style.display = state.permissions.new ? 'inline-flex' : 'none';
            addProfileBtn.style.display = state.profilePermissions.new ? 'inline-flex' : 'none';
        }

        // ==========================================
        // --- COLOR LIBRARY LOGIC ---
        // ==========================================

        function renderTable(scrollToBottom = false) {
            tableBody.innerHTML = '';
            state.colors.forEach((color) => {
                const isEditing = state.editingId === color.id;
                const tr = document.createElement('tr');
                if (isEditing) tr.className = 'edit-mode';

                if (isEditing) {
                    const canDelete = state.permissions.delete;
                    tr.innerHTML = `
                        <td>${color.slNo}</td>
                        <td>
                            <input type="text" class="form-input" id="edit-name-${color.id}" value="${color.name}" disabled>
                            <div class="error-msg" id="edit-error-${color.id}"></div>
                        </td>
                         <td>
                            ${canDelete ? `
                            <label class="switch">
                                <input type="checkbox" id="edit-status-${color.id}" ${color.status ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <span style="font-size: 12px; margin-left: 5px;">${color.status ? 'Active' : 'Inactive'}</span>
                            ` : `
                             <span class="status-badge ${color.status ? 'status-active' : 'status-inactive'}">
                                ${color.status ? 'Active' : 'Inactive'}
                            </span>
                            `}
                        </td>
                        <td style="text-align: center;">
                             <i class="fas fa-history" style="cursor: pointer; color: var(--primary-color);" onclick="showHistory('color', ${color.id})"></i>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-primary btn-sm" onclick="updateColor(${color.id})">Update</button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelEdit()"><i class="fas fa-times"></i></button>
                        </td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>${color.slNo}</td>
                        <td>${color.name}</td>
                        <td>
                            <span class="status-badge ${color.status ? 'status-active' : 'status-inactive'}">
                                ${color.status ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <i class="fas fa-history" style="cursor: pointer; color: var(--primary-color);" onclick="showHistory('color', ${color.id})"></i>
                        </td>
                        <td class="actions-cell">
                            ${state.permissions.edit ? 
                                `<button class="btn btn-icon-only" onclick="startEdit(${color.id})"><i class="fas fa-pencil-alt"></i></button>` : 
                                '<span style="color:#ccc; font-size:12px;">View Only</span>'
                            }
                        </td>
                    `;
                }
                tableBody.appendChild(tr);
            });

            if (state.isCreating) {
                const newRow = document.createElement('tr');
                newRow.className = 'edit-mode';
                newRow.innerHTML = `
                    <td>${state.nextSlNo}</td>
                    <td>
                        <input type="text" class="form-input" id="new-color-name" placeholder="Enter Color Name" autofocus>
                        <div class="error-msg" id="new-error"></div>
                    </td>
                    <td><span class="status-badge status-active">Active</span></td>
                     <td style="text-align: center;"><i class="fas fa-history" style="color: #ccc;"></i></td>
                    <td class="actions-cell">
                        <button class="btn btn-success btn-sm" onclick="saveNewColor()"><i class="fas fa-check"></i> Save</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelNew()"><i class="fas fa-times"></i></button>
                    </td>
                `;
                tableBody.appendChild(newRow);
            }
            if (scrollToBottom) { setTimeout(() => { mainScrollArea.scrollTop = mainScrollArea.scrollHeight; }, 100); }
        }

        function startAddNew() {
            if (state.editingId) cancelEdit(); 
            state.isCreating = true;
            renderTable(true);
            setTimeout(() => { const el = document.getElementById('new-color-name'); if(el) el.focus(); }, 150);
        }

        function cancelNew() {
            if(confirm("Discard changes?")) {
                state.isCreating = false;
                renderTable();
            }
        }

        function saveNewColor() {
            const input = document.getElementById('new-color-name');
            const errorDiv = document.getElementById('new-error');
            const name = input.value.trim();

            if (!name) { showInlineError(errorDiv, "Color Name is required"); return; }
            if (state.colors.some(c => c.name.toLowerCase() === name.toLowerCase())) { showInlineError(errorDiv, "Color Name must be unique"); return; }

            const newColor = {
                id: Date.now(),
                slNo: state.nextSlNo,
                name: name,
                status: true,
                history: [{ date: getFormattedDate(), action: 'Created', user: 'Demo User', details: 'Status: Active' }]
            };
            state.colors.push(newColor);
            state.nextSlNo++;
            state.isCreating = false;
            renderTable(true);
            showToast("Color '" + name + "' created successfully", 'success');
        }

        function startEdit(id) {
            if (state.isCreating) state.isCreating = false;
            state.editingId = id;
            renderTable();
        }

        function cancelEdit() {
            state.editingId = null;
            renderTable();
        }

        function updateColor(id) {
            const statusInput = document.getElementById(`edit-status-${id}`);
            const color = state.colors.find(c => c.id === id);
            
            let newStatus = color.status;
            if (state.permissions.delete && statusInput) {
                newStatus = statusInput.checked;
            }

            const changes = [];
            if (color.status !== newStatus) changes.push(`Status: ${color.status?'Active':'Inactive'} -> ${newStatus?'Active':'Inactive'}`);

            if (changes.length > 0) {
                color.status = newStatus;
                color.history.unshift({ date: getFormattedDate(), action: 'Updated', user: 'Demo User', details: changes.join(', ') });
                showToast("Color updated successfully", 'success');
            } else {
                 showToast("No changes made", 'success');
            }
            state.editingId = null;
            renderTable();
        }

        // ==========================================
        // --- PROFILE LIBRARY LOGIC ---
        // ==========================================

        function renderProfileTable(scrollToBottom = false) {
            profileTableBody.innerHTML = '';
            state.profiles.forEach((profile) => {
                const isEditing = state.editingProfileId === profile.id;
                const tr = document.createElement('tr');
                if (isEditing) tr.className = 'edit-mode';

                if (isEditing) {
                    const canDelete = state.profilePermissions.delete;
                    tr.innerHTML = `
                        <td>${profile.slNo}</td>
                        <td>
                            <input type="text" class="form-input" id="edit-profile-name-${profile.id}" value="${profile.name}" disabled>
                            <div class="error-msg" id="edit-profile-error-${profile.id}"></div>
                        </td>
                         <td>
                            ${canDelete ? `
                            <label class="switch">
                                <input type="checkbox" id="edit-profile-status-${profile.id}" ${profile.status ? 'checked' : ''}>
                                <span class="slider"></span>
                            </label>
                            <span style="font-size: 12px; margin-left: 5px;">${profile.status ? 'Active' : 'Inactive'}</span>
                            ` : `
                             <span class="status-badge ${profile.status ? 'status-active' : 'status-inactive'}">
                                ${profile.status ? 'Active' : 'Inactive'}
                            </span>
                            `}
                        </td>
                        <td style="text-align: center;">
                             <i class="fas fa-history" style="cursor: pointer; color: var(--primary-color);" onclick="showHistory('profile', ${profile.id})"></i>
                        </td>
                        <td class="actions-cell">
                            <button class="btn btn-primary btn-sm" onclick="updateProfile(${profile.id})">Update</button>
                            <button class="btn btn-secondary btn-sm" onclick="cancelEditProfile()"><i class="fas fa-times"></i></button>
                        </td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>${profile.slNo}</td>
                        <td>${profile.name}</td>
                        <td>
                            <span class="status-badge ${profile.status ? 'status-active' : 'status-inactive'}">
                                ${profile.status ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td style="text-align: center;">
                            <i class="fas fa-history" style="cursor: pointer; color: var(--primary-color);" onclick="showHistory('profile', ${profile.id})"></i>
                        </td>
                        <td class="actions-cell">
                            ${state.profilePermissions.edit ? 
                                `<button class="btn btn-icon-only" onclick="startEditProfile(${profile.id})"><i class="fas fa-pencil-alt"></i></button>` : 
                                '<span style="color:#ccc; font-size:12px;">View Only</span>'
                            }
                        </td>
                    `;
                }
                profileTableBody.appendChild(tr);
            });

            if (state.isCreatingProfile) {
                const newRow = document.createElement('tr');
                newRow.className = 'edit-mode';
                newRow.innerHTML = `
                    <td>${state.nextProfileSlNo}</td>
                    <td>
                        <input type="text" class="form-input" id="new-profile-name" placeholder="Enter Profile Name" autofocus>
                        <div class="error-msg" id="new-profile-error"></div>
                    </td>
                    <td><span class="status-badge status-active">Active</span></td>
                     <td style="text-align: center;"><i class="fas fa-history" style="color: #ccc;"></i></td>
                    <td class="actions-cell">
                        <button class="btn btn-success btn-sm" onclick="saveNewProfile()"><i class="fas fa-check"></i> Save</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelNewProfile()"><i class="fas fa-times"></i></button>
                    </td>
                `;
                profileTableBody.appendChild(newRow);
            }
            if (scrollToBottom) { setTimeout(() => { mainScrollArea.scrollTop = mainScrollArea.scrollHeight; }, 100); }
        }

        function startAddNewProfile() {
            if (state.editingProfileId) cancelEditProfile(); 
            state.isCreatingProfile = true;
            renderProfileTable(true);
            setTimeout(() => { const el = document.getElementById('new-profile-name'); if(el) el.focus(); }, 150);
        }

        function cancelNewProfile() {
            if(confirm("Discard changes?")) {
                state.isCreatingProfile = false;
                renderProfileTable();
            }
        }

        function saveNewProfile() {
            const input = document.getElementById('new-profile-name');
            const errorDiv = document.getElementById('new-profile-error');
            const name = input.value.trim();

            if (!name) { showInlineError(errorDiv, "Profile Name is required"); return; }
            if (state.profiles.some(p => p.name.toLowerCase() === name.toLowerCase())) { showInlineError(errorDiv, "Profile Name must be unique"); return; }

            const newProfile = {
                id: Date.now(),
                slNo: state.nextProfileSlNo,
                name: name,
                status: true,
                history: [{ date: getFormattedDate(), action: 'Created', user: 'Demo User', details: 'Status: Active' }]
            };
            state.profiles.push(newProfile);
            state.nextProfileSlNo++;
            state.isCreatingProfile = false;
            renderProfileTable(true);
            showToast("Profile '" + name + "' created successfully", 'success');
        }

        function startEditProfile(id) {
            if (state.isCreatingProfile) state.isCreatingProfile = false;
            state.editingProfileId = id;
            renderProfileTable();
        }

        function cancelEditProfile() {
            state.editingProfileId = null;
            renderProfileTable();
        }

        function updateProfile(id) {
            const statusInput = document.getElementById(`edit-profile-status-${id}`);
            const profile = state.profiles.find(p => p.id === id);
            
            let newStatus = profile.status;
            if (state.profilePermissions.delete && statusInput) {
                newStatus = statusInput.checked;
            }

            const changes = [];
            if (profile.status !== newStatus) changes.push(`Status: ${profile.status?'Active':'Inactive'} -> ${newStatus?'Active':'Inactive'}`);

            if (changes.length > 0) {
                profile.status = newStatus;
                profile.history.unshift({ date: getFormattedDate(), action: 'Updated', user: 'Demo User', details: changes.join(', ') });
                showToast("Profile updated successfully", 'success');
            } else {
                 showToast("No changes made", 'success');
            }
            state.editingProfileId = null;
            renderProfileTable();
        }

        // ==========================================
        // --- SHARED UTILS ---
        // ==========================================

        function showHistory(type, id) {
            let item;
            if (type === 'color') item = state.colors.find(c => c.id === id);
            else if (type === 'profile') item = state.profiles.find(p => p.id === id);

            document.getElementById('history-title').innerText = `${type === 'color' ? 'Color' : 'Profile'} History - ${item.name}`;
            const historyBody = document.getElementById('history-content');
            historyBody.innerHTML = '';
            item.history.forEach(h => {
                historyBody.innerHTML += `<tr><td>${h.date}</td><td>${h.action}</td><td>${h.user}</td><td>${h.details}</td></tr>`;
            });
            document.getElementById('history-modal').style.display = 'flex';
        }

        function closeHistory() {
            document.getElementById('history-modal').style.display = 'none';
        }

        function showInlineError(element, msg) {
            element.innerText = msg;
            element.style.display = 'block';
        }

        function showToast(msg, type) {
            toast.innerText = msg;
            toast.className = `toast ${type} show`;
            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        function getFormattedDate() {
            const now = new Date();
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            const pad = n => n < 10 ? '0'+n : n;
            return `${pad(now.getDate())}-${months[now.getMonth()]}-${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
        }

        // Init
        updateUIControls();
        renderTable();
        renderProfileTable();

    </script>
</body>
</html>
